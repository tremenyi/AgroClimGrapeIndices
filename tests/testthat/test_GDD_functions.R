context("GDD")


test_that("simple GDD is calculated correctly for positive results", {
  expect_equal(calc_GDD(24.12, 15.94, 10), 10.03)
  expect_equal(calc_GDD(14.6, 6.8, 7.1), 3.6)
})


test_that("simple GDD is zero when T_base > T_avg", {
  expect_equal(calc_GDD(11.7, 4.6, 10), 0)  # -1.85
})


test_that("weighted GDD is calculated correctly", {

  # Data --------------------------------------------------------------------

  # parameters
  params <- c(base_budb = 3.5,
              base_leaf = 7.1,
              bracket_budb_leaf = 350,
              bracket_leaf_pick = 1000,
              DMT_threshold_pctile = 0.95)

  # constants
  base_budb <- params[["base_budb"]]
  base_leaf <- params[["base_leaf"]]
  bracket_budb_leaf <- params[["bracket_budb_leaf"]]
  bracket_leaf_pick <- params[["bracket_leaf_pick"]]
  DMT_threshold_pctile <- params[["DMT_threshold_pctile"]]

  # sample temperature data
  x <- c(8.49, 9.95, 9.45, 11.58, 8.41, 8.76, 7.00, 8.33, 8.14, 8.88, 7.68, 7.48, 7.96, 8.86, 7.99, 7.09, 7.17, 7.00, 5.95, 5.54,
    4.65, 4.27, 7.96, 9.40, 8.92, 7.77, 8.72, 6.60, 9.57, 9.26, 9.04, 8.36, 8.77, 6.05, 6.45, 5.44, 7.37, 7.16, 11.00, 8.03,
    9.34, 7.95, 9.33, 10.69, 11.96, 9.63, 8.95, 9.32, 7.99, 8.81, 7.67, 8.91, 8.83, 6.69, 8.09, 7.39, 7.51, 9.78, 9.12, 8.49,
    7.11, 11.32, 10.84, 10.62, 9.87, 12.19, 9.41, 10.47, 11.81, 13.05, 13.69, 12.76, 13.77, 14.80, 12.91, 8.62, 9.46, 9.61, 9.29, 9.31,
    11.93, 11.40, 9.39, 11.21, 12.75, 17.66, 12.78, 10.36, 11.65, 16.29, 21.66, 21.83, 11.82, 10.09, 11.66, 12.84, 13.58, 16.78, 18.48,
    17.79, 20.92, 12.99, 12.48, 15.08, 16.72, 12.71, 8.46, 10.04, 15.25, 22.03, 20.71, 14.65, 10.01, 9.93, 13.20, 13.48, 11.92, 12.67, 12.80,
    16.07, 19.26, 22.61, 14.16, 11.17, 14.51, 17.79, 22.75, 27.78, 16.88, 12.58, 11.95, 11.44, 12.23, 12.00, 17.41, 20.32, 17.19, 12.96, 11.50,
    12.47, 15.46, 17.77, 19.10, 22.88, 16.46, 12.57, 13.02, 11.29, 13.41, 15.68, 19.78, 18.30, 15.88, 16.21, 20.67, 23.49, 18.60, 14.91, 12.80,
    11.92, 13.64, 14.96, 15.83, 16.29, 17.55, 18.08, 17.35, 20.28, 22.38, 16.31, 12.89, 11.82, 14.63, 18.37, 21.22, 22.94, 25.24, 23.52, 24.55,
    27.19, 21.57, 16.19, 15.41, 16.69, 17.35, 17.99, 19.02, 16.75, 16.39, 18.61, 19.73, 21.12, 20.94, 19.90, 18.50, 17.95, 19.67, 23.37, 27.95,
    28.02, 21.50, 18.39, 14.00, 15.29, 15.73, 15.65, 20.35, 24.44, 24.71, 20.47, 23.28, 23.85, 25.48, 20.93, 16.42, 15.06, 16.41, 16.29, 20.23,
    24.25, 26.22, 27.96, 19.79, 17.49, 14.66, 14.76, 20.65, 23.32, 15.80, 17.32, 19.12, 21.18, 24.91, 17.90, 16.66, 15.81, 15.69, 15.26, 17.00,
    16.93, 16.62, 20.05, 24.18, 14.42, 13.21, 15.34, 15.04, 15.60, 17.22, 19.24, 21.55, 20.09, 19.71, 19.53, 18.48, 18.91, 21.06, 23.05, 24.11,
    20.76, 16.88, 16.03, 17.23, 20.05, 15.87, 16.25, 17.27, 19.52, 21.88, 16.50, 15.27, 13.24, 14.56, 16.86, 19.72, 19.62, 16.48, 12.89, 11.43,
    13.44, 15.59, 16.56, 13.73, 13.43, 12.63, 12.72, 13.39, 11.50, 10.53, 11.84, 12.39, 12.41, 14.07, 15.20, 18.64, 20.57, 14.50, 14.31, 17.04,
    23.08, 22.80, 14.43, 9.39, 11.16, 8.92, 9.32, 10.04, 10.94, 11.45, 12.19, 8.80, 10.92, 9.87, 9.35, 8.80, 9.04, 10.04, 11.20, 15.02,
    10.08, 11.00, 11.70, 9.97, 10.38, 10.46, 9.28, 7.67, 9.36, 8.81, 8.90, 8.13, 9.16, 8.09, 11.08, 12.43, 15.15, 12.30, 11.50, 10.33,
    11.25, 12.33, 12.05, 12.65, 11.10, 10.23, 11.01, 11.26, 11.83, 8.39, 10.64, 11.81, 11.77, 14.43, 13.75, 12.07, 10.94, 7.45, 8.08, 11.28,
    9.36, 6.61, 7.40, 10.27, 9.29, 7.22)

  # Test --------------------------------------------------------------------

  # manually pre calculated answer from spreadsheet
  pre_calc_GDD_weighted <- 2251.370

  # for simplicity, T_max = T_min, and thus = T_avg
  GDD_base_10 <- calc_GDD(x, x, 10)
  GDD_base_budb <- calc_GDD(x, x, base_budb)
  GDD_base_leaf <- calc_GDD(x, x, base_leaf)

  GDD_weighted <- calc_GDD_weighted(GDD_base_budb, GDD_base_leaf, GDD_base_10, params)

  GDD_weighted_last_val <- GDD_weighted[length(GDD_weighted)]
  expect_equal(GDD_weighted_last_val, pre_calc_GDD_weighted)
})



test_that("calc_accumulated_heat calculates Accumulated Heat (GDD) correctly when one bracket not reached", {

  # Data --------------------------------------------------------------------

  # data from region 1, Austral_season_year = 1962
  dates <- seq(as.Date("1962-07-01"), as.Date("1963-06-30"), "days")
  values <- c(
    0, 0, 0.79, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.29, 0, 2.62, 0, 0, 0, 0, 0, 0, 0, 0.37, 0, 0, 0,
    0, 0, 0.47, 0, 0, 0, 0, 0, 0, 0, 0, 0.08, 0, 0, 1.11, 1.15, 0.85, 0, 0, 0, 0, 0, 0, 0, 0, 1.53, 6.61, 2.1, 0.32, 1.52, 0.8,
    1.29, 4.5, 8.14, 9.51, 0, 0, 0.85, 0.21, 1.22, 3.12, 0, 0, 0, 0, 0.88, 0, 0, 0, 0.1, 0, 0.71, 3.43, 3.89, 2.03, 0.8, 2.75, 0.16, 0, 0, 0,
    1.2, 0, 4.37, 1.64, 1.6, 0, 0, 0.95, 0, 0, 2.79, 4.42, 2.89, 0.68, 2.98, 7.25, 3.27, 0.56, 1.82, 0.72, 0.64, 4.66, 0.83, 0.58, 3.07, 7.79, 4.42, 0.04, 1.28, 5.58, 4.59,
    1.28, 1.9, 0.2, 0.99, 2.42, 5.77, 5.07, 6.18, 13.06, 4.96, 4.66, 3.28, 4.58, 12.17, 5.37, 9.15, 9.3, 6.08, 12.89, 2.5, 2.63, 4.51, 3.69, 4.27, 5.66, 10.04, 8.42, 10.67, 14.34, 21.07,
    12.03, 3.36, 2.53, 2.78, 2.93, 3.53, 5.07, 2.69, 4.58, 2.37, 2.84, 3.81, 5.28, 6.37, 11.07, 10.1, 12.28, 7.75, 5.31, 6.69, 10.91, 15.13, 14.89, 2.82, 4.52, 7.79, 6.01, 8.85, 10.42, 11.5, 14.17,
    9.39, 14.08, 6.04, 4.9, 5.59, 5.9, 9.05, 12.5, 14.19, 16.58, 15.26, 14.26, 6.42, 3.14, 2.99, 1.82, 2.1, 4.62, 5.87, 9.41, 14.86, 9.7, 5.86, 7.34, 11.94, 14.2, 11.74, 8.58, 6.1, 8.21, 11.86,
    8.97, 6.73, 5.25, 3.99, 5.36, 9.5, 12.29, 9.37, 10.35, 8.51, 10.68, 18.23, 7.58, 5.51, 5.13, 3.92, 6.87, 5.65, 7.19, 12.22, 10.1, 7.28, 8.32, 6.74, 8.79, 13.91, 14.65, 20.55,
    10.17, 7.34, 9.38, 10.65, 10.65, 4.62, 4.02, 7.78, 7.72, 4.67, 4.65, 5.76, 10.02, 9.69, 7.61, 7.39, 8.32, 7.92, 9.41, 13.52, 14.63, 12.74, 6.83, 7.19, 6.92, 3.76, 2.63, 2.62, 2.89, 3.32, 0.78,
    3.73, 3.44, 3.29, 2.2, 2.74, 5.03, 6.82, 4.01, 2.65, 1.47, 1.68, 4.22, 1.53, 0, 0, 1.47, 3.58, 5.24, 7.86, 2.05, 1.66, 5.56, 10.26, 9.03, 5.14, 3.78, 4.85, 4.61, 3.9, 2.41,
    1.17, 0, 0, 0, 0, 0, 1.35, 3.69, 3.58, 3.54, 4.21, 5.19, 5.16, 5.03, 3.33, 2.41, 0.69, 0, 0.69, 0.25, 0, 0.69, 0, 0, 0.7, 1.66, 2.44, 0, 0, 1.5, 2.6,
    2.42, 2.57, 0.61, 0.56, 1.08, 0, 0.57, 0, 0, 2.43, 1.27, 2.78, 1.4, 1.36, 0.99, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

  test_data <- data.frame(
    Time_string = dates,
    Austral_season_month = ifelse(as.numeric(format(dates, "%m")) %in% 1:6, as.numeric(format(dates, "%m")) + 6, as.numeric(format(dates, "%m")) - 6),
    GDD_base10 <- values
  )


  # Test --------------------------------------------------------------------

  # pre calculated answer from spreadsheet
  exp_date_aug_1100 <- as.Date('1963-03-03')
  exp_date_aug_1300 <- as.Date('1963-03-30')
  exp_date_aug_1500 <- NA

  exp_date_sep_1100 <- as.Date('1963-03-05')
  exp_date_sep_1300 <- as.Date('1963-04-05')
  exp_date_sep_1500 <- NA

  exp_date_oct_1100 <- as.Date('1963-03-12')
  exp_date_oct_1300 <- as.Date('1963-04-19')
  exp_date_oct_1500 <- NA

  # GDD_Season_Aug <- calc_accumulated_heat(test_data, test_data$GDD_base10, 2)
  #
  # expect_equal(calc_accumulated_heat_threshold(GDD_Season_Aug, GDD_Season_Aug$GDD_base10, 1100), exp_date_aug_1100)
  # expect_equal(calc_accumulated_heat_threshold(GDD_Season_Aug, GDD_Season_Aug$GDD_base10, 1300), exp_date_aug_1300)
  # expect_equal(calc_accumulated_heat_threshold(GDD_Season_Aug, GDD_Season_Aug$GDD_base10, 1500), exp_date_aug_1500)
  #
  # result <- calc_accumulated_heat(test_data, test_data$GDD_base10, 3, c(1100, 1300, 1500))
  #
  # expect_equal(result[["1100"]], exp_date_sep_1100)
  # expect_equal(result[["1300"]], exp_date_sep_1300)
  # expect_equal(is.na(result[["1500"]]), is.na(exp_date_sep_1500))
  #
  # result <- calc_accumulated_heat(test_data, test_data$GDD_base10, 4, c(1100, 1300, 1500))
  #
  # expect_equal(result[["1100"]], exp_date_oct_1100)
  # expect_equal(result[["1300"]], exp_date_oct_1300)
  # expect_equal(is.na(result[["1500"]]), is.na(exp_date_oct_1500))
})
